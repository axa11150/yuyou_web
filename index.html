<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>xxxx</title>
  <link rel="shortcut icon" href="./favicon3.ico">
  <meta name="renderer" content="webkit">
  <meta name="robots" content="noindex">
  <!--old_des-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" href="layui/css/layui.css" media="all">
  <!--图片拖拽gridly-->
  <script src="./lib/jquery-2.1.4/jquery.min.js" type="text/javascript"></script>
  <script src="./lib/jquery.gridly/javascripts/jquery.gridly.js" type="text/javascript"></script>
  <link href="./lib/jquery.gridly/stylesheets/jquery.gridly.css" rel="stylesheet" type="text/css" />
  <!--xm-select-->
  <!--https://hnzzmsf.github.io/example/example_v4.html-->
  <link rel="stylesheet" href="./lib/formSelects/formSelects-v4.css" />
  <script src="./lib/formSelects/formSelects-v4.js" type="text/javascript" charset="utf-8"></script>
  <script src="lib/formSelects/area_data2.js" type="text/javascript" charset="utf-8"></script>
  <script src="lib/formSelects/area_data_value2.js" type="text/javascript" charset="utf-8"></script>
  <!--加密-->
  <!--<script src="./lib/CryptoJS/rollups/aes.js" type="text/javascript" charset="utf-8"></script>-->
  <!--二维码-->
  <!--https://github.com/neocotic/qrious-->
  <script src="./lib/qrcode/qrious.min.js"></script>
  <!--<script src="./lib/qrcode/qrcode.min.js" type="text/javascript" charset="utf-8"></script>-->
  <!--socketio-->
  <!--<script src='../lib/socket.io2.0.3/socket.io.js'></script>-->
  <!--Bootstrap Tags Input输入框 标签 Bootstrap3-->
  <!--文档地址 http://bootstrap-tagsinput.github.io/bootstrap-tagsinput/examples/-->
  <link rel="stylesheet" href="./lib/bootstrap-tagsinput/css/bootstrap/bootstrap.css">
  <link rel="stylesheet" href="./lib/bootstrap-tagsinput/bootstrap-tagsinput.css">
  <script src="./lib/bootstrap-tagsinput/bootstrap-tagsinput.js"></script>
  <script src="./lib/bootstrap-tagsinput/js/bootstrap.min.js"></script>
  <!--notice-->
  <!--文档地址 http://www.html#误报#eaf.com/jQuery/Layout-Interface/201708054668.html-->
  <link rel="stylesheet" href="./lib/notice/bootoast.css">
  <script src="./lib/notice/bootoast.js"></script>
  <!--md5-->
  <!--https://github.com/blueimp/JavaScript-MD5-->
  <script src="./lib/md5/md5.min.js"></script>
  <!--视频云-->
  <script type="text/javascript" src="https://player.dogecloud.com/js/uploader"></script>
  <!--剪贴板复制插件-->
  <script src="./lib/clipboard/clipboard.min.js"></script>
  <style>
    /*全屏变灰*/
    .gray {overflow-y:scroll;filter:progid:DXImageTransform.Microsoft.BasicImage(grayscale=1);-webkit-filter: grayscale(100%);}
  </style>
</head>
<body>

<div id="LAY_app"></div>
<!--提示音-->
<audio src='./static/music/1.mp3' type="audio/mpeg" style='display:none' id='tb_beep'></audio>
<script src="layui/layui.js"></script>
</body>
<script>
  //有效期检测
  function is_validity() {
    let end_time = layui.data('layuiAdmin').authorize_end_time;
    if ((new Date(end_time) - new Date())  < 0) {
      return false
    }else {
      return true
    }
  }
</script>

<script>
  sys_type = "sys#type";
  parent_id = "116";
  // sys_type = "jx";
  // sys_type = "xds";
  // sys_type = "yy";
  xds_top_image_path = "./static/image/top1.png";
  task_table_reload_time = Date.now()
  layui.config({
    base: './src/' //指定 layuiAdmin 项目路径，本地开发用 src，线上用 dist
    ,version: ''
    // ,version: new Date().getTime()
    ,layimPath: './layui/lay/modules/' //配置 layim.js 所在目录
    ,layimAssetsPath: './layui/lay/modules/layim-assets/' //layim 资源文件所在目录
    ,debug: true
  }).extend({
    soulTable: 'soulTable/soulTable',
    tableChild: 'soulTable/tableChild',
    tableMerge: 'soulTable/tableMerge',
    tableFilter: 'soulTable/tableFilter',
    excel: 'soulTable/excel',
  }).use('index');
  if (localStorage.getItem("web_replay_sound") != null){
    document.getElementById("tb_beep").src=localStorage.getItem("web_replay_sound");
  }

  layui.use(['layim','layer','setter','admin','form','table'], function(){
    var $ = layui.$
      ,setter = layui.setter
      ,layer = layui.layer
      ,admin = layui.admin
      ,form = layui.form
      ,table = layui.table
      ,layim = layui.layim;

    $.ajax({
      type: "GET", url: 'https://api.api-z.cn/check',
      success: function (response,status,xhr) {
        console.log(xhr.status);	//状态码,   要看其他的直接 输出 xhr 就行
          layui.setter.domain = ''
      error: function () {
        layui.setter.domain = ''
        console.log("请求失败");
      }
    });

    //如果没有jwt，不绑定websocket 不初始化im
    if (!layui.data('layuiAdmin').access_token) {
      return
    }
    ws = new WebSocket("wss://wss.yuxianxian.com:443");
    ws_re_num = 0;
    websocketInit();
    setInterval(function(){
      ws.send("h");
    }, 20000);
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?09be1aa5598654e56aa4f9d8191cdd73";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    function websocketInit() {
      ws.onmessage = function(e){
        // json数据转换成js对象
        if(e.data =='H'){
          return true
        }
        var data = eval("("+e.data+")");
        var type = data.type || '';
        switch(type){
          // Events.php中返回的init类型的消息，将client_id发给后台进行uid绑定
          case 'init':
            // 利用ajax请求，将client_id发给后端进行uid绑定
            console.log("client_id：" + data.client_id);
            $.ajax({
              url: layui.setter.domain + 'gateway_bind'
              // url: 'https://api.api-z.cn/gateway_bind'
              // url: 'https://api.yuxianxian.com/gateway_bind'//稳定的
              ,type: 'POST'
              ,data: {
                client_id: data.client_id,
                access_token: JSON.parse(localStorage.getItem("layuiAdmin")).access_token
              }
              ,success:function (e) {
                console.log(e)
                if (e.code == '-2'){
                  layer.alert(e.msg,{icon: 2,title:"警告"})
                } else {
                  // layer.msg("连接成功");
                  console.log("client_id绑定成功（总控连接成功）");
                  $("html").removeClass("gray");
                }
              }
              ,error:function (e) {
                alert("与总控绑定出现错误，请刷新浏览器")
                console.log("与总控绑定出现错误");
                console.log(e);
              }

            });
            break;
          //aj 发来的日志
          case 'aj_to_web_back_message':
            console.log('aj发来消息，需要打印')
            let timeout = 1;
            switch (data.status) {
              case 'info':
                timeout = 2;
                break;
              case 'success':
                timeout = 2;
                break;
              case 'warning':
                timeout = 5;
                break;
              case 'danger':
                timeout = 8;
                break;
              default:
                break;
            }
            bootoast({
              message: data.msg,
              type: data.status,  //info success warning danger
              position: 'right-top',
              icon: undefined,
              timeout: timeout,  //多久后消失
              animationDuration: 500, //消失动画时间
              dismissable: true  //是否显示关闭按钮
            });
            break;
          //chat 聊天部分`
          case 'aj_to_web_chat_message':
            //提示音
            document.getElementById('tb_beep').play();

            console.log(data)
            //对象数组去重 聊天记录去重
            let  new_im_msg =unique(JSON.parse(data.im_msg));
            //如果消息大于19条，只取后19条
            if (new_im_msg.length>=19){
              new_im_msg = new_im_msg.reverse();
              new_im_msg = new_im_msg.slice(0,19);
              new_im_msg = new_im_msg.reverse();
            }

            //去重函数
            function unique(arr){
              let unique = {};
              arr.forEach(function(item){
                unique[JSON.stringify(item)]=item;//键名不会重复
              })
              arr = Object.keys(unique).map(function(u){
                //Object.keys()返回对象的所有键值组成的数组，map方法是一个遍历方法，返回遍历结果组成的数组.将unique对象的键名还原成对象数组
                return JSON.parse(u);
              })
              return arr;
            }

            let buyer_id = data['jwt']['u_id']+'_'+data['android_id']+'_'+ data['buyer_name'] +'_'+data['goods_description'];
            console.log(buyer_id);
            buyer_id = md5(buyer_id);
            console.log(buyer_id);

            // 将新用户添加到主面板（先移除再添加，防止出现好友已在列表的提示）
            layim.removeList({
              type: 'friend' //或者group
              ,id: buyer_id //好友或者群组ID
            });
            layim.addList({
              type: 'friend' //列表类型，只支持friend和group两种
              ,avatar: './static/image/avatar/'+data['buyer_name'].charCodeAt(0).toString(16)[0]+'.png' //消息来源用户头像
              ,username: data['buyer_name']+'　'+data['android_name'] +'　'+data['status'] //好友昵称
              ,groupid: data['jwt']['u_id']+'_'+data['android_id'] //所在的分组id
              ,id: buyer_id  //好友id
              ,sign: data.goods_description //好友签名
              ,status: data.status  //交易状态
              ,goods_description: data.goods_description
              ,price: data.price
              ,aj_room_id: data['jwt']['u_id']+'_'+data['android_id']+'_'+ data['buyer_name']
            });

            if(!new_im_msg.length){
              new_im_msg.push({
                "role": "buyer",
                "message": "买家未发送文字信息\n交易状态：\n"+data.status
              })
            }
            for(let i=0;i<new_im_msg.length;i++){
              let d = new_im_msg[i];
              console.log(d)
              layim.getMessage({
                username: d['role'] =='seller'?"我":data['buyer_name'] //消息来源用户名
                ,avatar: d['role'] =='seller'?layui.layim.cache().mine.avatar:'./static/image/avatar/'+data['buyer_name'].charCodeAt(0).toString(16)[0]+'.png' //消息来源用户头像
                ,id: buyer_id //消息的来源ID（如果是私聊，则是用户id，如果是群聊，则是群组id）
                ,type: 'friend' //聊天窗口来源类型，从发送消息传递的to里面获取
                ,content: d['message'] //消息内容
                ,cid: 0 //消息id，可不传。除非你要对消息进行一些操作（如撤回）
                ,mine: d['role'] =='seller'?true:false //是否我发送的消息，如果为true，则会显示在右方
                ,fromid: d['role'] =='seller'?'10000':buyer_id //消息的发送者id（比如群组中的某个消息发送者），可用于自动解决浏览器多窗口时的一些问题
                ,timestamp: new Date().getTime() //服务端时间戳毫秒数。注意：如果你返回的是标准的 unix 时间戳，记得要 *1000
              })
              // setTimeout(function () {
              // },i*100)
            }
            break;
          //监听aj发来的表格重载 task/run
          case 'reload_task_table':
            // console.log('收到重载task数据表命令 reload_task_table')
            // console.log(data)
            // 重载执行命令界面表格
            if (typeof task_run_table !== "undefined"){
              let ms = 2500;
              if (Date.now() - task_table_reload_time >= ms) {
                task_table_reload_time = Date.now() + ms;
                setTimeout(function () {
                  console.log("重载task_run_table")
                  task_run_table.reload();
                },ms+200)
                console.log("创建reload_task_table定时器")
              }else {
                // console.log("已有reload_task_table定时器")
              }
            }
            break;
          //监听服务器发来的表格重载 spider/run
          case 'reload_spider_table':
            console.log('收到重载task数据表命令 reload_spider_table')
            console.log(data)
            // 重载执行命令界面表格
            if (typeof spider_log_table !== "undefined"){
              spider_log_table.reload();
              console.log("重载spider_log_table")
            }
            break;
          case 'device_online':
            bootoast({
              message: data.msg,
              type: "success",  //info success warning danger
              position: 'right-top',
              icon: undefined,
              timeout: 2,  //多久后消失
              animationDuration: 500, //消失动画时间
              dismissable: true  //是否显示关闭按钮
            });

              console.log('收到重载task数据表命令 device_online')
            if(typeof device_list_table !== "undefined"){
              device_list_table.reload();
              console.log("重载device_list_table")
            }
            if (typeof task_run_table !== "undefined"){
              task_run_table.reload();
              console.log("重载task_run_table")
            }
            break;
          default :
            console.log('aj发来的消息没有匹配到，type为：'+type)
            console.log(e.data)
        }

      };

      ws.onopen = function(evt) {
        ws_re_num = 0;
        console.log("ws已连接");
      };
      ws.onclose = function (event) {
        console.log("ws已断开，2秒后重连");
        $("html").addClass("gray");
        setTimeout(function () {
          ws_re_num +=1;
          if (ws_re_num<20000){
            console.log("开始重连");
            ws = new WebSocket("wss://wss.yuxianxian.com:443");
            websocketInit()
          }
        },2*1000);
      };
    }




    });


    //监听聊天窗口的切换
    layim.on('chatChange', function(obj){
      console.log("聊天窗口打开或切换");
      console.log(obj);
      let maijai_status_str = ""
      maijai_status_str += obj.data.price
      maijai_status_str +=" "
      maijai_status_str += obj.data.goods_description
      layim.setChatStatus(maijai_status_str);
    });


    //监听签名修改
    layim.on('sign', function(value){
      layer.msg(value)
      // admin.req({
      //   url: layui.setter['domain'] + 'edit_user',
      //   type: 'POST',
      //   data: {'remark':value},
      //   dataType: 'json',
      //   done: function (data) {
      //     layer.msg("修改成功")
      //   },
      // })
    });

    //监听layim建立就绪
    layim.on('ready', function(options){
      console.log(options);
      console.log(options.history);
      Object.values(options.history).forEach(function (item) {
        layim.addList(item)
      })
    });

    //监听发送消息
    layim.on('sendMessage', function(data){
      console.log(data);
      if (data.mine.content.indexOf("img[") !== -1){
        data.mine.content = data.mine.content.replace("img[",'').replace("?imageView2/1/w/200/h/200]",'')
      }
      if (data.mine.content.indexOf("audio[") !== -1){
        data.mine.content = data.mine.content.replace("audio[",'').replace("]",'')
      }
      if (data.mine.content.indexOf("video[") !== -1){
        data.mine.content = data.mine.content.replace("video[",'').replace("]",'')
      }
      admin.req({
        url: layui.setter['domain'] + 'gateway_send_message',
        type: 'POST',
        data: {
          type:'web_to_aj_chat_message',
          aj_room_id:data.to.aj_room_id,
          // aj_room_id:data.to.id,
          // name:data.to.name.split("_")[0],
          name:data.to.name.split("　")[0],
          message:data.mine.content
        },
        dataType: 'json',
        done: function (data) {
          console.log(data);
        },
      })

    });


  });

  // array要分割的数组，totalParts分割成几部分
  function splitArrayIntoTenths(array,totalParts) {
    const partLength = Math.floor(array.length / totalParts);
    const remainder = array.length % totalParts;
    let result = [];
    let currentIndex = 0;

    for (let i = 0; i < totalParts; i++) {
      // 前remainder个部分每部分多一个元素
      const length = partLength + (i < remainder ? 1 : 0);
      const part = array.slice(currentIndex, currentIndex + length);
      result.push(part);
      currentIndex += length;
    }
    return result;
  }

  //点击元素自动复制
  const clipboard = new ClipboardJS('.copy_self');  //通过类名.btn的元素实例化
  clipboard.on('success', function (e) {
    layer.msg(e.text+" 复制成功");
  });
  clipboard.on('error', function (e) {
    console.log("对不起，您的浏览器暂不支持一键复制功能！");
  });

</script>

<!--base url安全-->
<script src="./lib/base64/base64.js"></script>
<!--<script src="./static/json/zhuanzhuan/category2.js"></script>-->
<script src="./static/json/zhuanzhuan/sql6/category_main.js"></script>
<script src="./static/json/zhuanzhuan/sql6/category_temp.js"></script>
<script src="./static/youpin/youpin_diqu.js"></script>
<script src="./static/youpin/youpin_leimu.js"></script>
<!--视频-->
<script type="text/javascript" src="https://player.dogecloud.com/js/loader"></script>

</html>